name: Check License Updates

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'

jobs:
  check-licenses:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Restore dependencies
        run: dotnet restore
      
      - name: Run nuget-license
        run: |
          dotnet tool restore
          dotnet nuget-license -i Wigo4it.MultiTenant.slnx -o Markdown -fo THIRD-PARTY-NOTICES.md -a allowed-licenses.json --override-package-information override-package-information.json
      
      - name: Check if THIRD-PARTY-NOTICES.md was updated
        run: |
          if ! git diff --quiet THIRD-PARTY-NOTICES.md; then
            echo "❌ THIRD-PARTY-NOTICES.md is out of date"
            echo "Run 'dotnet nuget-license -i Wigo4it.MultiTenant.slnx -o Markdown -fo THIRD-PARTY-NOTICES.md -a allowed-licenses.json --override-package-information override-package-information.json' locally and commit the changes"
            git diff THIRD-PARTY-NOTICES.md
            exit 1
          else
            echo "✅ THIRD-PARTY-NOTICES.md is up to date"
          fi
